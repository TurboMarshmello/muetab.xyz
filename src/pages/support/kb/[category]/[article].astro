---
import { changeLanguage, i18n } from "i18next";
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";
import getContributors from "@lib/getContributors";
import Page from "@layouts/Page.astro";
import { Debug } from "astro/components";
import getSearchIndex from "@/lib/getSearchIndex";
import getLocale from "@/lib/getLocale";

changeLanguage("en");

type Modify<T, R> = Omit<T, keyof R> & R;
type KnowledgebaseArticle = Modify<
	CollectionEntry<"knowledgebase">,
	{
		slug: string;
	}
>;

export async function getStaticPaths() {
	const parts = import.meta.url.split("/");
	let locale = parts[parts.length - 5];
	locale = locale === "pages" ? "en" : locale;
	const articles: KnowledgebaseArticle[] = await getCollection(
		"knowledgebase"
	);
	const categories = new Set(
		articles.map((article) => article.slug.split("/")[1])
	);
	return [...categories].map((category) => {
		return articles
			.filter((article) => article.slug.split("/").shift() === locale)
			.map((article, i, articles) => {
				article.slug = article.slug.split("/").slice(2).join("/");
				return {
					params: { category, article: article.slug },
					props: {
						next: articles[i + 1],
						prev: articles[i - 1],
						article,
					},
				};
			});
	});
}
type Props = {
	next: KnowledgebaseArticle | undefined;
	prev: KnowledgebaseArticle | undefined;
	article: KnowledgebaseArticle;
};
const { article, next, prev } = Astro.props;
const {
	Content,
	remarkPluginFrontmatter: { readingTime },
} = await article.render();
const contributors = await getContributors(
	`src/content/knowledgebase/${article.id}`
);
const searchIndex = JSON.parse(await getSearchIndex(getLocale(Astro.url.pathname)));
const articles: KnowledgebaseArticle[] = await getCollection("knowledgebase");
---

<Page frontmatter={{ title: article.data.title }}>
	{Math.ceil(readingTime.minutes)} mins
		<Content />
		<Debug data={{ prev, next }} />
</Page>
